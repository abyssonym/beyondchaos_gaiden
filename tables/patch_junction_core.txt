.addr   jun-checker                         610000
.addr   jun-checker-y                       6100a0

.addr   jun-check-whitelist                 610100
.addr   jun-check-blacklist                 610180
.addr   jun-check-list                      6101e0
.addr   jun-check-equip-whitelist           610200
.addr   jun-check-equip-blacklist           610210
.addr   jun-check-whitelist-monster-version 610220
.addr   jun-check-blacklist-monster-version 610240
.addr   jun-check-status-whitelist          610260
.addr   jun-check-status-blacklist          6102b0
.addr   jun-check-rage                      610300

.addr   jun-always-whitelist                611000
.addr   jun-character-whitelist             611800
.addr   jun-character-blacklist             611c00
.addr   jun-esper-whitelist                 612000
.addr   jun-esper-blacklist                 612400
.addr   jun-status-whitelist                612800
.addr   jun-status-blacklist                612c00
.addr   jun-equip-whitelist                 613000
.addr   jun-equip-blacklist                 613800
.addr   jun-monster-whitelist               614000
.addr   jun-monster-blacklist               614800

.addr   jun-mult                            610800
.addr   jun-divide                          610860
.addr   jun-rng1                            610820
.addr   jun-rng2                            610830
.addr   jun-rng3                            610840
.addr   jun-select-bit                      6108a0
.addr   jun-bit-to-index                    6108d0
.addr   jun-count-bits                      6108c0

.addr   jun-dispatcher-address-c2           02af18
.addr   jun-dispatcher-return               610fff
.addr   jun-queue-command                   610ff0
.addr       command-queue-routine               024eb2
.addr   jun-queue-self-spell                610fc0
.addr       self-spell-queue-routine            024e91
.addr   jun-reload-character-commands       610f80
.addr       load-character-commands-routine     02532c
.addr       command-change-byte-address     18500a

.addr   jun-check-entity-living             610600
.addr       living-characters                   7e3a74
.addr       living-enemies                      7e3a75
.addr   jun-check-entity-present            610640
.addr       present-characters                  7e3a78
.addr       present-enemies                     7e3a79
.addr   jun-check-entity-can-act            6106c0
.addr   jun-check-count-all-living          610680
.addr   jun-check-inventory                 610700
.addr   jun-deduct-item-if-possible         610740
.addr   jun-set-target-allies               610780
.addr   jun-set-target-counter              6107c0

.addr   bits                                00bafc
.addr   wide-bits                           00b4f3
.addr   wide-bits-monster                   00b4eb

.addr   monster-indexes                     7e1ff9
.addr   inventory-address                   7e2686
.addr   inventory-quantity-address          7e2689
.addr   character-info                      7e3010
.addr   rage-indexes                        7e33a8

.def    jun-data-bank       61

# PARAMETERS:   junction index in A, (actor index * 2) in X
# RETURNS:      sets zero bit if check passes, otherwise clears zero bit
$jun-checker
:   48 eb 48 eb da 5a 8b 08
:   e2 30
:   e0 08
:   b0 is-monster
:   c2 30
:   bc $character-info,2
:   c0 ff ff
:   f0 final-exit-check-failed
:   80 begin-checking

.label is-monster
:   c2 30
:   bc $monster-indexes,2
:   c0 ff ff
:   f0 final-exit-check-failed

.label begin-checking
:   29 ff 00
:   a8

# change the data bank register
:   e2 20
:   a9 jun-data-bank
:   48
:   ab
:   c2 20

# maybe unnecessary, save the contents of $10-$15 so we can use it for scratch
:   a5 10
:   48
:   a5 12
:   48
:   a5 14
:   48

:   84 10
:   64 12
:   86 14
:   e0 08 00
:   b0 is-still-monster

:   bf $character-info
:   69 00 16
:   85 11
:   20 $jun-check-whitelist,2
:   f0 no-whitelist
:   20 $jun-check-blacklist,2
:   49 01 00
:   80 no-whitelist

.label is-still-monster
:   20 $jun-check-whitelist-monster-version,2
:   f0 no-whitelist
:   20 $jun-check-blacklist-monster-version,2
:   49 01 00

.label no-whitelist
:   aa
:   68
:   85 14
:   68
:   85 12
:   68
:   85 10
:   8a
:   e2 20
:   c9 00
:   d0 final-exit-check-passed
.label final-exit-check-failed
:   28 ab 7a fa 68 eb 68
:   e2 02
:   6b
.label final-exit-check-passed
:   28 ab 7a fa 68 eb 68
:   c2 02
:   6b

$jun-check-list
#   X   - list address
#   $10 - junction index

:   a9 00 00
:   e2 20
.label check-list-loop
:   bd 00 00
:   f0 check-list-found-nothing
:   e8
:   c5 10
:   d0 check-list-loop
:   a9 01
.label check-list-found-nothing
:   c2 20
:   60

$jun-checker-y
:   da
:   bb
:   22 $jun-checker
:   fa
:   6b

$jun-check-whitelist
#   Y   - list offset
#   X   - list address
#   $10 - junction index
#   $11 - character data address (unused for monsters)
#   $14 - battle index

:   a9 00 00
:   a8
:   be $jun-always-whitelist,2
:   20 $jun-check-list,2
:   d0 found-whitelist

:   a0 00 00
:   b7 11
:   29 ff 00
:   0a
:   a8
:   be $jun-character-whitelist,2
:   20 $jun-check-list,2
:   d0 found-whitelist

:   a0 1e 00
:   b7 11
:   29 ff 00
:   c9 ff 00
:   f0 jcwl-no-esper
:   0a
:   a8
:   be $jun-esper-whitelist,2
:   20 $jun-check-list,2
:   d0 found-whitelist
.label jcwl-no-esper

:   a0 24 00
:   20 $jun-check-equip-whitelist,2
:   d0 found-whitelist

:   a0 23 00
:   20 $jun-check-equip-whitelist,2
:   d0 found-whitelist

:   a0 22 00
:   20 $jun-check-equip-whitelist,2
:   d0 found-whitelist

:   a0 21 00
:   20 $jun-check-equip-whitelist,2
:   d0 found-whitelist

:   a0 20 00
:   20 $jun-check-equip-whitelist,2
:   d0 found-whitelist

:   a0 1f 00
:   20 $jun-check-equip-whitelist,2
:   d0 found-whitelist

:   20 $jun-check-status-whitelist,2
:   d0 found-whitelist

:   20 $jun-check-rage,2

.label found-whitelist
:   60

$jun-check-whitelist-monster-version
#   Y   - list offset
#   X   - list address
#   $10 - junction index
#   $14 - battle index

:   a9 00 00
:   a8
:   be $jun-always-whitelist,2
:   20 $jun-check-list,2
:   d0 found-whitelist-monster-version

:   a6 14
:   bf $monster-indexes
:   0a
:   a8
:   be $jun-monster-whitelist,2
:   20 $jun-check-list,2
:   d0 found-whitelist-monster-version
:   20 $jun-check-status-whitelist,2
.label found-whitelist-monster-version
:   60

$jun-check-rage
:   a6 14
:   bf f9 3e 7e
:   89 01 00
:   f0 no-rage
:   bf $rage-indexes
:   c9 ff ff
:   f0 no-rage
:   0a
:   a8
:   be $jun-monster-whitelist,2
:   20 $jun-check-list,2
:   60
.label no-rage
:   a9 00 00
:   60

$jun-check-equip-whitelist
:   b7 11
:   29 ff 00
:   0a
:   a8
:   be $jun-equip-whitelist,2
:   20 $jun-check-list,2
:   60

$jun-check-status-whitelist
:   a0 00 00

:   a6 14
:   bf e4 3e 7e
.label status-white-loop1
:   4a
:   90 status-white-skip1
:   be $jun-status-whitelist,2
:   5a
:   48
:   98
:   20 $jun-check-list,2
:   d0 status-white-found
:   68
:   7a
.label status-white-skip1
:   c8 c8
:   c0 20 00
:   d0 status-white-loop1

:   a6 14
:   bf f8 3e 7e
.label status-white-loop2
:   4a
:   90 status-white-skip2
:   be $jun-status-whitelist,2
:   5a
:   48
:   98
:   20 $jun-check-list,2
:   d0 status-white-found
:   68
:   7a
.label status-white-skip2
:   c8 c8
:   c0 40 00
:   d0 status-white-loop2

:   a9 00 00
:   60
.label status-white-found
:   7a
:   7a
:   60

$jun-check-blacklist
:   a0 00 00
:   b7 11
:   29 ff 00
:   0a
:   a8
:   be $jun-character-blacklist,2
:   20 $jun-check-list,2
:   d0 found-blacklist

:   a0 1e 00
:   b7 11
:   29 ff 00
:   c9 ff 00
:   f0 jcbl-no-esper
:   0a
:   a8
:   be $jun-esper-blacklist,2
:   20 $jun-check-list,2
:   d0 found-blacklist
.label jcbl-no-esper

:   a0 24 00
:   20 $jun-check-equip-blacklist,2
:   d0 found-blacklist

:   a0 23 00
:   20 $jun-check-equip-blacklist,2
:   d0 found-blacklist

:   a0 22 00
:   20 $jun-check-equip-blacklist,2
:   d0 found-blacklist

:   a0 21 00
:   20 $jun-check-equip-blacklist,2
:   d0 found-blacklist

:   a0 20 00
:   20 $jun-check-equip-blacklist,2
:   d0 found-blacklist

:   a0 1f 00
:   20 $jun-check-equip-blacklist,2
:   d0 found-blacklist

:   20 $jun-check-status-blacklist,2

.label found-blacklist
:   60

$jun-check-blacklist-monster-version
:   a6 14
:   bf $monster-indexes
:   0a
:   a8
:   be $jun-monster-blacklist,2
:   20 $jun-check-list,2
:   d0 found-blacklist-monster-version
:   20 $jun-check-status-blacklist,2
.label found-blacklist-monster-version
:   60

$jun-check-equip-blacklist
:   b7 11
:   29 ff 00
:   0a
:   a8
:   be $jun-equip-blacklist,2
:   20 $jun-check-list,2
:   60

$jun-check-status-blacklist
:   a0 00 00

:   a6 14
:   bf e4 3e 7e
.label status-black-loop1
:   4a
:   90 status-black-skip1
:   be $jun-status-blacklist,2
:   5a
:   48
:   98
:   20 $jun-check-list,2
:   d0 status-black-found
:   68
:   7a
.label status-black-skip1
:   c8 c8
:   c0 20 00
:   d0 status-black-loop1

:   a6 14
:   bf f8 3e 7e
.label status-black-loop2
:   4a
:   90 status-black-skip2
:   be $jun-status-blacklist,2
:   5a
:   48
:   98
:   20 $jun-check-list,2
:   d0 status-black-found
:   68
:   7a
.label status-black-skip2
:   c8 c8
:   c0 40 00
:   d0 status-black-loop2

:   a9 00 00
:   60
.label status-black-found
:   7a
:   7a
:   60

$jun-mult
:   08
:   c2 20
:   8f 02 42 00
:   ea ea ea ea
:   af 16 42 00
:   28
:   6b

$jun-divide
:   5a
:   08
:   c2 20
:   8f 04 42 00
:   e2 30
:   8a
:   8f 06 42 00
:   ea ea ea ea  ea ea ea ea
:   af 16 42 00
:   aa
:   c2 20
:   af 14 42 00
:   28
:   7a
:   6b

# 0 or 1 (in carry bit)
$jun-rng1
:   48
:   22 $jun-rng2
:   4a
:   68
:   6b

# 0 to 255
$jun-rng2
:   da
:   e6 be
:   a6 be
:   bf 00 fd c0
:   fa
:   6b

# 0 to A-1
$jun-rng3
:   da
:   08
:   e2 30
:   eb
:   48
:   e6 be
:   a6 be
:   bf 00 fd c0
:   22 $jun-mult
:   68
:   eb
:   28
:   fa
:   6b

$jun-bit-to-index
:   48
:   22 $jun-count-bits
:   e0 01
:   d0 bit-to-index-fail
:   68
:   a2 00
.label bit-to-index-loop
:   e8
:   4a
:   d0 bit-to-index-loop
:   ca
:   6b
.label bit-to-index-fail
:   68
:   a2 ff
:   6b

$jun-count-bits
:   a2 00
:   4a
:   90 01
:   e8
:   d0 fa
:   6b

$jun-select-bit
:   5a
:   08
:   c2 20
:   85 ee
:   22 $jun-count-bits
:   8a
:   f0 0e
:   22 $jun-rng3
:   aa
:   38
:   7b
:   2a
:   24 ee
:   f0 fb
:   ca
:   10 f8
:   28
:   7a
:   6b

$jun-check-entity-living
#   X - battle index
:   48 08
:   e2 20
:   8a
:   c9 08
:   b0 check-living-is-monster
:   bd 18 30
:   2c $living-characters,2
:   f0 check-living-no
:   bd f9 3e
:   89 20
:   d0 check-living-no
:   80 check-living-yes
.label check-living-is-monster
:   bf $wide-bits-monster
:   2c $living-enemies,2
:   d0 check-living-yes
.label check-living-no
:   28 68
:   e2 02
:   6b
.label check-living-yes
:   28 68
:   c2 02
:   6b

$jun-check-entity-present
#   X - battle index
:   48
:   8a
:   c9 08
:   b0 check-present-is-monster
:   bd 18 30
:   2c $present-characters,2
:   d0 check-present-yes
:   80 check-present-no
.label check-present-is-monster
:   bf $wide-bits-monster
:   2c $present-enemies,2
:   d0 check-present-yes
.label check-present-no
:   68
:   e2 02
:   6b
.label check-present-yes
:   68
:   c2 02
:   6b

$jun-check-entity-can-act
#   X - battle index
:   48 08
:   c2 20
:   22 $jun-check-entity-living
:   f0 check-can-act-no
:   bd e4 3e
:   89 c2 b0
:   d0 check-can-act-no
:   bd f8 3e
:   89 10 02
:   d0 check-can-act-no
:   28 68
:   c2 02
:   6b
.label check-can-act-no
:   28 68
:   e2 02
:   6b

$jun-check-count-all-living
#   A - junction index
:   08 da 5a
:   e2 30

:   a0 00
:   a2 12
.label all-living-loop
:   22 $jun-check-entity-living
:   f0 all-living-skip
:   22 $jun-checker
:   f0 all-living-skip
:   c8
.label all-living-skip
:   ca ca
:   10 all-living-loop

:   a9 00
:   eb
:   98
:   7a fa 28
:   6b

$jun-check-inventory
:       c2 10
:       08
:       c2 30
:       29 ff 00
:       48
:       a2 00 00
.label check-inventory-loop
:       8a
:       09 00 05
:       22 $jun-mult
:       a8
:       b9 $inventory-address,2
:       29 ff 00
:       c3 01
:       f0 check-inventory-found
:       e8
:       e0 00 01
:       d0 check-inventory-loop
.label check-inventory-fail
:       68
:       28
:       e2 02
:       6b
.label check-inventory-found
:       b9 $inventory-quantity-address,2
:       f0 check-inventory-fail
:       68
:       28
:       c2 02
:       6b

$jun-deduct-item-if-possible
:       da 5a 08
:       22 $jun-check-inventory
:       f0 deduct-item-fail
:       e2 20
:       48
:       de $inventory-quantity-address,2
:       bd $inventory-quantity-address,2
:       d0 not-last-item
:       a9 ff
:       99 $inventory-address,2
.label not-last-item
:       68 28 7a fa
:       c2 02
:       6b
.label deduct-item-fail
:       28 7a fa
:       e2 02
:       6b

$jun-set-target-allies
:       08
:       e2 20
:       a5 b8
:       f0 enemy-targeting
:       a9 0f
:       85 b8
.label enemy-targeting
:       a5 b9
:       f0 exit-set-target-allies
:       a9 3f
:       85 b9
.label exit-set-target-allies
:       28
:       6b

$jun-set-target-counter
:       48 5a 08 da
:       e2 20
:       64 b8
:       64 b9
:       b9 e0 32
:       29 7f
:       c9 0a
:       b0 no-counter-target
:       0a
:       c3 01
:       f0 no-counter-target
:       a8
:       c2 20
:       b9 18 30
:       85 b8
.label no-counter-target
:       fa 28 7a 68
:       6b

$jun-dispatcher-address-c2
:       ea
:       5c $jun-dispatcher-return

$jun-dispatcher-return
:       60

$jun-queue-command
:       08
:       62 queue-command-reentry,2
:       f4 $jun-dispatcher-address-c2,2
:       5c $command-queue-routine
.label queue-command-reentry
:       28
:       6b

$jun-queue-self-spell
:       08
:       e2 20
:       85 b8
:       a9 26
:       62 queue-self-spell-reentry,2
:       f4 $jun-dispatcher-address-c2,2
:       5c $self-spell-queue-routine
.label queue-self-spell-reentry
:       28
:       6b

$jun-reload-character-commands
:       da 5a 08
:       c2 10
:       e2 20
:       bc 10 30

:       9c d6 11
:       da
:       a2 05 00
.label command-changer-loop
:       b9 1f 16
:       da
:       eb
:       a9 1e
:       22 $jun-mult
:       aa
:       bf $command-change-byte-address
:       0d d6 11
:       8d d6 11
:       fa
:       c8
:       ca
:       10 command-changer-loop
:       fa

:       62 reload-commands-reentry,2
:       f4 $jun-dispatcher-address-c2,2
:       5c $load-character-commands-routine
.label reload-commands-reentry
:       28 7a fa
:       6b

VALIDATION

$jun-dispatcher-address-c2
:       ff ff ff ff ff
